<!--
  @description       : 
  @author            : ChangeMeIn@UserSettingsUnder.SFDoc
  @group             : 
  @last modified on  : 09-27-2024
  @last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
-->
<template>
    <lightning-card title="Imputaciones" icon-name="custom:custom63">
        <template if:true={imputaciones}>
            <!-- Leyenda sobre las búsquedas -->
            <p style="margin-left: 15px; margin-bottom: 10px"> <b>Nota: </b> Escribe el username o el project ID y da clic en la lupa para buscar:</p>

            <!-- Input de búsqueda centrados -->
            <div class="slds-grid slds-grid_align-center slds-m-bottom_small">
                <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                    <lightning-input label="Buscar por Username:" value={usernameSearchTerm} onchange={handleUsernameInput} style="font-weight: bold;"></lightning-input>
                    <lightning-button-icon icon-name="utility:search" alternative-text="Buscar por Username" onclick={searchByUsername} class="slds-m-top_small" style="margin-top: 15px;"></lightning-button-icon>
                </div>
                <div class="slds-col slds-size_1-of-2 slds-p-left_small">
                    <lightning-input label="Buscar por Project ID: " value={projectIdSearchTerm} onchange={handleProjectIdInput} style="font-weight: bold;"></lightning-input>
                    <lightning-button-icon icon-name="utility:search" alternative-text="Buscar por Project ID: " onclick={searchByProjectId} class="slds-m-top_small" style="margin-top: 15px;"></lightning-button-icon>
                </div>
            </div>

            <!-- Botón de Exportar a Excel -->
            <div class="slds-m-bottom_small slds-align_absolute-center" style="margin-top: 10px; display: flex; justify-content: center;">
                <lightning-button 
                    label="Exportar a Excel" 
                    icon-name="utility:download" 
                    onclick={exportToExcel}>
                </lightning-button>
            </div>

            <!-- Tabla de imputaciones paginada -->
            <template if:true={currentPageImputaciones.length}>
                <table class="slds-table slds-table_cell-buffer slds-table_bordered" style="margin-top: 1rem; width: 95%; margin: auto; border: 1px solid grey;">
                    <thead>
                        <tr>
                            <th scope="col">Usuario</th>
                            <th scope="col">Proyecto ID</th>
                            <th scope="col">Tarea</th>
                            <th scope="col">Horas Imputadas</th>
                            <th scope="col">Fecha de Imputación</th>
                            <th scope="col">Acciones</th> 
                        </tr>
                    </thead>
                    <tbody>
                        <template for:each={currentPageImputaciones} for:item="imputacion">
                            <tr key={imputacion.Id}>
                                <td>{imputacion.username__c}</td>
                                <td>{imputacion.proyectoId__c}</td>
                                <td>{imputacion.Name}</td>
                                <td>{imputacion.horasImputadas__c}</td>
                                <td>{imputacion.fechaImputacion__c}</td>
                                <td>
                                    <lightning-button label="Editar Imputación" onclick={openEditModal} data-id={imputacion.Id}></lightning-button>
                                    <lightning-button variant="destructive" label="Eliminar" onclick={deleteImputacion} data-id={imputacion.Id} class="slds-m-left_small"></lightning-button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                
                <!-- Paginación -->
                <div class="pagination" style="margin-top: 1rem; display: flex; justify-content: center; gap: 5px; align-items:center">
                    <lightning-button 
                        onclick={handlePreviousPage} 
                        icon-name="utility:chevronleft"
                        icon-position="left">
                    </lightning-button>
                    <span> {currentPage} / {totalPages}</span>
                    <lightning-button 
                        icon-name="utility:chevronright"
                        icon-position="left"
                        onclick={handleNextPage}>
                    </lightning-button>
                </div>
            </template>

            <!-- Gráficos dinámicos -->
            <div style="display: flex; justify-content: center; gap: 15px">
                <div class="chart-container" style="margin-top: 2rem; width:45%">
                    <h3>Gráfico de Horas Imputadas por Proyecto</h3>
                    <div class="chart chart-project-hours" lwc:dom="manual" style="border: 1px solid #d3d3d3; padding: 1rem;"></div>
                </div>

                <div class="chart-container" style="margin-top: 2rem; width:45%">
                    <h3>Gráfico de Distribución de Tareas por Usuario</h3>
                    <div class="chart chart-user-tasks" lwc:dom="manual" style="border: 1px solid #d3d3d3; padding: 1rem;"></div>
                </div>
            </div>
            <div style="display: flex; justify-content: center">
                <div class="chart-container" style="margin-top: 2rem; width:90%">
                    <h3>Tendencia Mensual de Horas Imputadas</h3>
                    <div class="chart-monthly-trend" lwc:dom="manual" style="border: 1px solid #d3d3d3; padding: 1rem; "></div>
                </div>
            </div>
        </template> 
        <template if:true={isModalOpen}>
            <c-editar-imputacion selected-imputacion={selectedImputacion}></c-editar-imputacion>
        </template>

        <!-- Mostrar error si algo va mal -->
        <template if:true={error}>
            <c-error-panel errors={error}></c-error-panel>
        </template>
    </lightning-card>
</template>
